<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BGMI Studio v50 - ADMIN MULTI MATCH</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

  <style>
    :root { --accent:#00e5ff; }

    *{box-sizing:border-box;font-family:'Bahnschrift',Arial,sans-serif;}
    body{
      margin:0;
      background:#111;
      color:#fff;
      padding-left:330px;
      overflow:hidden;
    }

    /* LEFT ADMIN PANEL */
    #admin{
      width:310px;
      height:100vh;
      background:#111;
      position:fixed;
      left:0;top:0;
      padding:15px;
      border-right:2px solid #333;
      overflow-y:auto;
      font-size:11px;
      z-index:1000;
    }
    h3{margin:0 0 10px 0;}
    .btn-main{
      background:var(--accent);
      color:#000;
      width:100%;
      padding:10px;
      border:none;
      font-weight:900;
      cursor:pointer;
      border-radius:4px;
      text-transform:uppercase;
      margin-bottom:8px;
    }
    .config-sec{
      background:#1a1a1a;
      padding:10px;
      margin-bottom:12px;
      border-radius:4px;
      border-top:2px solid var(--accent);
    }
    .config-sec h4{
      margin:0 0 8px 0;
      color:var(--accent);
      text-transform:uppercase;
      font-size:10px;
    }
    label{display:block;margin-top:5px;color:#888;}
    input[type="text"],input[type="number"],select{
      width:100%;
      background:#000;
      color:#fff;
      border:1px solid #444;
      padding:5px;
      font-size:11px;
    }
    input[type="range"]{
      width:100%;
      accent-color:var(--accent);
    }

    /* TEAM CONTROL ROWS */
    #teamControls{
      margin-top:8px;
    }
    .team-ctrl{
      background:#222;
      padding:5px;
      margin-bottom:4px;
      display:grid;
      grid-template-columns:30px 60px 1.3fr 40px 40px 40px 55px 35px;
      gap:4px;
      align-items:center;
      border-radius:3px;
      font-size:10px;
    }
    .team-ctrl input[type="number"]{
      padding:3px;
      text-align:center;
    }
    .team-ctrl input[type="text"]{
      padding:3px;
    }
    .slot{width:100%;}
    .logo-url{width:100%;}
    .name{width:100%;}
    .alive{width:100%;}
    .finish{width:100%;}
    .kills{width:100%;}
    .totalPts{
      text-align:center;
      font-weight:bold;
      color:#00e5ff;
    }
    .deadFlag{width:100%;text-align:center;}

    .small-label-row{
      display:grid;
      grid-template-columns:30px 60px 1.3fr 40px 40px 40px 55px 35px;
      gap:4px;
      font-size:9px;
      margin-bottom:2px;
      color:#aaa;
    }

    /* MODAL FOR BULK TEAM EDIT (optional) */
    #modal{
      position:fixed;
      top:5%;left:340px;right:20px;
      height:85%;
      background:#111;
      padding:20px;
      border:1px solid var(--accent);
      display:none;
      z-index:1001;
      color:#fff;
      overflow-y:auto;
    }
    #modal input[type="text"],#modal input[type="number"]{
      font-size:11px;
    }

    /* SIMPLE INFO AREA ON RIGHT (DEBUG / CURRENT MATCH) */
    #infoBar{
      position:fixed;
      bottom:10px;left:330px;
      right:20px;
      background:#181818;
      padding:8px 12px;
      font-size:11px;
      border-radius:4px;
      border:1px solid #333;
      opacity:0.9;
    }
  </style>
</head>
<body>

<div id="admin">
  <h3>BGMI Studio ‚Äì ADMIN</h3>

  <!-- MATCH SELECT -->
  <div class="config-sec">
    <h4>üéÆ Match Selector</h4>
    <label>Current Match</label>
    <div style="display:flex;gap:5px;">
      <select id="matchSelect" onchange="changeMatch(this.value)" style="flex:1;"></select>
      <button onclick="addMatch()" style="width:70px;background:#0f0;color:#000;border:none;font-weight:bold;cursor:pointer;">+M</button>
    </div>
    <small>Example: Match 1, Match 2... sabka data alag store hoga.</small>
  </div>

  <!-- BACKGROUND / DESIGN SETTINGS -->
  <div class="config-sec">
    <h4>üñºÔ∏è Background PNG Overlay</h4>
    <label>PNG Image URL</label>
    <input type="text" id="bg-url" placeholder="Paste PNG link here" onchange="setSetting('bg-url',this.value)">
  </div>

  <!-- TEAM ROWS HEADER -->
  <div class="config-sec">
    <h4>üìã Teams ‚Äì Current Match</h4>
    <div class="small-label-row">
      <span>#</span>
      <span>Logo</span>
      <span>Name</span>
      <span>A</span>
      <span>Fin</span>
      <span>K</span>
      <span>Total</span>
      <span>Elim</span>
    </div>
    <div id="teamControls"></div>
    <button class="btn-main" onclick="addTeamRow()">+ Add Team Row</button>
    <button class="btn-main" style="background:#ffb300;color:#000;" onclick="saveCurrentMatch()">üíæ SAVE MATCH</button>
    <button class="btn-main" style="background:#ff4444;color:#fff;" onclick="recomputeGlobal()">‚ü≥ REBUILD TOTALS</button>
  </div>

  <!-- OPTIONAL BULK EDIT MODAL OPEN -->
  <button class="btn-main" onclick="toggleModal()">Bulk Edit (Names / Logos)</button>
</div>

<!-- BULK EDIT MODAL -->
<div id="modal">
  <h3>Bulk Team Edit ‚Äì <span id="modalMatchName"></span></h3>
  <div id="bulkInputs"></div>
  <button onclick="addTeamRow(true)" style="background:#0f0;color:#000;border:none;padding:8px 12px;margin-top:8px;cursor:pointer;">+ Add Team</button>
  <button onclick="saveBulk()" class="btn-main" style="margin-top:10px;">Save Changes</button>
  <button onclick="toggleModal()" style="background:#444;color:#fff;border:none;padding:6px 10px;margin-top:10px;cursor:pointer;">Close</button>
</div>

<!-- INFO BAR -->
<div id="infoBar">
  <span id="infoText">Loading‚Ä¶</span>
</div>

<script>
  /* ---------- FIREBASE INIT (same DB as view panel) ---------- */
  const firebaseConfig = { databaseURL:"https://live-pt-67ab3-default-rtdb.firebaseio.com" };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  /* ---------- CONFIG ---------- */
  const placePts = {1:10,2:6,3:5,4:4,5:3,6:2,7:1,8:1};
  const killPoint = 1;

  let currentMatchId = null;
  let allMatches = {};   // cache snapshot for quick ops

  /* ---------- SETTINGS HELPERS ---------- */
  function setSetting(key,val){ db.ref('settings/'+key).set(val); }

  /* ---------- LOAD MATCH LIST ---------- */
  function loadMatchList(){
    db.ref('matches').once('value').then(snap=>{
      allMatches = snap.val() || {};
      const select = document.getElementById('matchSelect');
      select.innerHTML = '';
      const keys = Object.keys(allMatches).sort();
      if(keys.length === 0){
        // create first match
        const mid = 'm1';
        allMatches[mid] = { name:'Match 1', teams:[] };
        db.ref('matches').set(allMatches);
      }
      const finalKeys = Object.keys(allMatches).sort();
      finalKeys.forEach(k=>{
        const opt = document.createElement('option');
        opt.value = k;
        opt.textContent = allMatches[k].name || k;
        select.appendChild(opt);
      });
      currentMatchId = finalKeys[0];
      select.value = currentMatchId;
      loadMatch(currentMatchId);
    });
  }

  function addMatch(){
    const num = Object.keys(allMatches || {}).length + 1;
    const mid = 'm'+num;
    allMatches[mid] = { name:'Match '+num, teams:[] };
    db.ref('matches').set(allMatches).then(loadMatchList);
  }

  function changeMatch(id){
    currentMatchId = id;
    loadMatch(currentMatchId);
  }

  /* ---------- RENDER TEAM ROWS FOR CURRENT MATCH ---------- */
  function loadMatch(matchId){
    if(!matchId) return;
    db.ref('matches/'+matchId).once('value').then(snap=>{
      const data = snap.val() || { name:'Match ?', teams:[] };
      if(!data.teams) data.teams = [];
      allMatches[matchId] = data;
      document.getElementById('infoText').innerText =
        `Editing ${data.name} | Teams: ${data.teams.length}`;
      renderTeamControls(data.teams);
      buildBulkInputs(data.teams);
    });
  }

  function renderTeamControls(teams){
    const box = document.getElementById('teamControls');
    box.innerHTML = '';
    teams.forEach((t,i)=>{
      const div = document.createElement('div');
      div.className = 'team-ctrl';
      div.dataset.index = i;
      div.innerHTML = `
        <input type="number" class="slot" value="${t.teamNo||i+1}">
        <input type="text" class="logo-url" value="${t.logo||''}">
        <input type="text" class="name" value="${t.name||'TEAM'}">
        <input type="number" class="alive" min="0" max="4" value="${t.alive||0}">
        <input type="number" class="finish" min="1" max="64" value="${t.finish||''}">
        <input type="number" class="kills" min="0" value="${t.kills||0}">
        <span class="totalPts">${t.matchPts||0}</span>
        <input type="checkbox" class="deadFlag" ${t.dead?'checked':''}>
      `;
      // inputs change listeners
      div.querySelectorAll('input').forEach(inp=>{
        inp.addEventListener('change',()=>recalcRow(div));
      });
      box.appendChild(div);
    });
  }

  function addTeamRow(alsoToBulk=false){
    if(!currentMatchId) return;
    const teams = allMatches[currentMatchId]?.teams || [];
    teams.push({
      teamNo: teams.length+1,
      logo:'',
      name:'TEAM',
      alive:4,
      finish:'',
      kills:0,
      basePts:0,
      matchPts:0,
      totalPts:0,
      dead:false
    });
    allMatches[currentMatchId].teams = teams;
    renderTeamControls(teams);
    buildBulkInputs(teams);
  }

  /* ---------- PER ROW RECALC ---------- */
  function recalcRow(rowDiv){
    const idx = parseInt(rowDiv.dataset.index,10);
    const t = getRowData(rowDiv);
    const calc = calcMatchPoints(t);
    t.basePts = calc.basePts;
    t.matchPts = calc.matchPts;
    rowDiv.querySelector('.totalPts').textContent = calc.matchPts;

    // update in allMatches + DB
    const teams = allMatches[currentMatchId].teams;
    teams[idx] = t;
    db.ref(`matches/${currentMatchId}/teams`).set(teams);
    document.getElementById('infoText').innerText =
      `Auto-saved ${allMatches[currentMatchId].name} | Team ${t.teamNo}`;
  }

  function getRowData(div){
    return {
      teamNo: parseInt(div.querySelector('.slot').value)||0,
      logo:   div.querySelector('.logo-url').value,
      name:   div.querySelector('.name').value.toUpperCase(),
      alive:  parseInt(div.querySelector('.alive').value)||0,
      finish: parseInt(div.querySelector('.finish').value)||0,
      kills:  parseInt(div.querySelector('.kills').value)||0,
      dead:   div.querySelector('.deadFlag').checked
    };
  }

  function calcMatchPoints(t){
    const base = placePts[t.finish] || 0;
    const kills = t.kills || 0;
    const matchPts = base + kills*killPoint;
    return {basePts:base, matchPts};
  }

  /* ---------- SAVE CURRENT MATCH (ALL ROWS) ---------- */
  function saveCurrentMatch(){
    const rows = Array.from(document.querySelectorAll('.team-ctrl'));
    const teams = rows.map(r=>{
      const t = getRowData(r);
      const calc = calcMatchPoints(t);
      t.basePts = calc.basePts;
      t.matchPts = calc.matchPts;
      return t;
    });
    allMatches[currentMatchId].teams = teams;
    db.ref('matches/'+currentMatchId).set(allMatches[currentMatchId]).then(()=>{
      renderTeamControls(teams);
      buildBulkInputs(teams);
      document.getElementById('infoText').innerText =
        `Saved ${allMatches[currentMatchId].name} | Teams: ${teams.length}`;
      // recompute lastElim helper (optional)
      updateLastElimOnSave(teams);
    });
  }

  // Optional helper: last eliminated = sabse latest dead jiski finish sabse badhi
  function updateLastElimOnSave(teams){
    const deadTeams = teams.filter(t=>t.dead && t.finish);
    if(deadTeams.length===0) return;
    deadTeams.sort((a,b)=>b.finish-a.finish); // last finish highest
    const last = deadTeams[0];
    db.ref('lastElim').set({
      name:last.name,
      logo:last.logo,
      kills:last.kills||0,
      rank:last.finish,
      time:Date.now()
    });
  }

  /* ---------- RECOMPUTE GLOBAL TOTALS (all matches) ---------- */
  function recomputeGlobal(){
    db.ref('matches').once('value').then(snap=>{
      const matches = snap.val() || {};
      const totals = {};   // key: teamNo string -> {name,logo,totalPts}

      Object.values(matches).forEach(m=>{
        (m.teams||[]).forEach(t=>{
          const key = t.teamNo || 0;
          if(!key) return;
          const {matchPts} = calcMatchPoints(t);
          if(!totals[key]) totals[key] = {
            teamNo:key,
            name:t.name,
            logo:t.logo,
            totalPts:0
          };
          totals[key].totalPts += matchPts;
        });
      });

      db.ref('globalTotals/teams').set(totals).then(()=>{
        document.getElementById('infoText').innerText =
          `Global totals rebuilt for ${Object.keys(totals).length} teams`;
      });
    });
  }

  /* ---------- BULK EDIT MODAL ---------- */
  function buildBulkInputs(teams){
    const box = document.getElementById('bulkInputs');
    const title = document.getElementById('modalMatchName');
    if(!allMatches[currentMatchId]) return;
    title.textContent = allMatches[currentMatchId].name;
    box.innerHTML = '';
    teams.forEach((t,i)=>{
      const row = document.createElement('div');
      row.style.display = 'grid';
      row.style.gridTemplateColumns = '30px 1.2fr 2fr 60px';
      row.style.gap = '5px';
      row.style.marginBottom = '5px';
      row.innerHTML = `
        <input type="number" value="${t.teamNo||i+1}" id="bSlot-${i}">
        <input type="text" value="${t.name||'TEAM'}" id="bName-${i}">
        <input type="text" value="${t.logo||''}" id="bLogo-${i}">
        <button onclick="deleteTeam(${i})" style="background:#ff4444;color:#fff;border:none;font-size:10px;cursor:pointer;">DEL</button>
      `;
      box.appendChild(row);
    });
  }

  function toggleModal(){
    const m = document.getElementById('modal');
    m.style.display = (m.style.display==='block')?'none':'block';
  }

  function deleteTeam(index){
    const teams = allMatches[currentMatchId].teams || [];
    teams.splice(index,1);
    allMatches[currentMatchId].teams = teams;
    db.ref('matches/'+currentMatchId+'/teams').set(teams).then(()=>{
      renderTeamControls(teams);
      buildBulkInputs(teams);
    });
  }

  function saveBulk(){
    const teams = allMatches[currentMatchId].teams || [];
    teams.forEach((t,i)=>{
      const slot = document.getElementById(`bSlot-${i}`);
      const name = document.getElementById(`bName-${i}`);
      const logo = document.getElementById(`bLogo-${i}`);
      if(!slot) return;
      t.teamNo = parseInt(slot.value)||0;
      t.name   = (name.value||'TEAM').toUpperCase();
      t.logo   = logo.value||'';
    });
    allMatches[currentMatchId].teams = teams;
    db.ref('matches/'+currentMatchId+'/teams').set(teams).then(()=>{
      renderTeamControls(teams);
      buildBulkInputs(teams);
      document.getElementById('infoText').innerText =
        `Bulk save done for ${allMatches[currentMatchId].name}`;
    });
  }

  /* ---------- INIT ---------- */
  loadMatchList();
</script>
</body>
</html>
