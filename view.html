<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BGMI Studio – VIEW PANEL</title>

  <!-- Firebase CDN (same project use karna jaisa admin file me hai) -->
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Bahnschrift',Arial,sans-serif;}
    body{
      margin:0;
      background:transparent;
      overflow:hidden;
      color:#fff;
    }

    /* BG PNG from settings/bg-url */
    #bg-image{
      position:fixed;
      inset:0;
      background-position:center;
      background-size:contain;
      background-repeat:no-repeat;
      pointer-events:none;
      opacity:1;
    }

    /* ---------- TOP STRIPS (4 teams) ---------- */
    .top-bar{
      position:absolute;
      top:20px;
      left:50%;
      transform:translateX(-50%);
      display:flex;
      gap:40px;
      z-index:10;
    }
    .team-strip-wrap.dead .team-strip{filter:grayscale(1);opacity:0.4;}
    .team-strip{
      width:240px;
      height:72px;
      display:flex;
      background:#f8a93a;
      box-shadow:0 0 10px rgba(0,0,0,0.6);
      font-size:14px;
      text-transform:uppercase;
    }
    .team-strip-logo{
      width:70px;
      background:#2a0c0e;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight:bold;
      background-size:cover;
      background-position:center;
    }
    .team-strip-body{
      flex:1;
      padding:6px 10px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }
    .team-strip-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-weight:bold;
    }
    .team-strip-header span.small{font-size:12px;}
    .team-strip-footer{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .life-bars{display:flex;gap:3px;}
    .life-bar{width:8px;height:18px;background:#2a0c0e;}
    .kills-box{
      margin-left:auto;
      font-weight:bold;
      color:#2a0c0e;
      font-size:16px;
    }

    /* ---------- ELIMINATION POPUP ---------- */
    .elim-popup{
      position:absolute;
      top:80px;
      left:50%;
      transform:translateX(-50%);
      width:540px;
      height:120px;
      display:none;
      grid-template-columns:140px 1fr;
      background:#2a0c0e;
      box-shadow:0 0 25px rgba(0,0,0,0.8);
      overflow:hidden;
      z-index:20;
    }
    .elim-left{
      background:#2a0c0e;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      color:#f8a93a;
      font-weight:bold;
    }
    .elim-left .logo{
      width:70px;
      height:70px;
      border-radius:50%;
      border:3px solid #f8a93a;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      background-size:cover;
      background-position:center;
    }
    .elim-right{
      background:#3a1013;
      padding:10px 18px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      position:relative;
    }
    .elim-tag{
      position:absolute;
      top:0;
      left:0;
      background:#f8a93a;
      color:#2a0c0e;
      padding:4px 14px;
      font-weight:bold;
      font-size:14px;
    }
    .elim-team-name{
      margin-top:22px;
      font-size:22px;
      font-weight:bold;
    }
    .elim-stats{
      margin-top:6px;
      display:flex;
      gap:25px;
      font-size:14px;
      text-transform:uppercase;
    }
    .elim-stats span.label{
      color:#f8a93a;
      font-weight:bold;
      margin-right:6px;
    }

    /* ---------- RIGHT RANK TABLE + FORECAST ---------- */
    .right-panel{
      position:absolute;
      top:90px;
      right:40px;
      width:260px;
      background:#2a0c0e;
      box-shadow:0 0 18px rgba(0,0,0,0.7);
      font-size:13px;
      text-transform:uppercase;
      z-index:10;
    }
    .table-header,.table-row{
      display:grid;
      grid-template-columns:26px 1fr 60px 32px;
      align-items:center;
      height:26px;
    }
    .table-header{
      background:#4a1518;
      font-weight:bold;
      font-size:11px;
    }
    .table-header div{padding:0 6px;}
    .table-body{max-height:360px;overflow:hidden;}
    .table-row{background:#7b2224;color:#fff;}
    .table-row:nth-child(2n){background:#6a1c1f;}
    .cell{padding:0 6px;}
    .status-bars{display:flex;gap:2px;}
    .status-bar{width:5px;height:16px;background:#f8a93a;}
    .row-dead{opacity:0.45;}

    .legend{
      display:flex;
      justify-content:flex-end;
      gap:12px;
      padding:6px 8px;
      background:#2a0c0e;
      font-size:11px;
    }
    .box-alive,.box-dead{
      width:10px;
      height:10px;
      display:inline-block;
      margin-right:4px;
    }
    .box-alive{background:#7b2224;}
    .box-dead{background:#f8a93a;}

    .forecast{
      margin-top:4px;
      border-top:2px solid #f8a93a;
      padding:6px 8px 8px;
      background:#3a1013;
      font-size:11px;
    }
    .forecast-title{
      font-weight:bold;
      margin-bottom:4px;
      color:#f8a93a;
    }
    .forecast-row{
      display:flex;
      justify-content:space-between;
      margin:1px 0;
    }
  </style>
</head>
<body>

<div id="bg-image"></div>

<!-- TOP BAR: yahan sirf top 4 alive teams dikhayenge -->
<div class="top-bar" id="topBar"></div>

<!-- ELIMINATION POPUP -->
<div class="elim-popup" id="elimPopup">
  <div class="elim-left">
    <div class="logo" id="elimLogo"></div>
  </div>
  <div class="elim-right">
    <div class="elim-tag">ELIMINATED</div>
    <div class="elim-team-name" id="elimName">TEAM NAME</div>
    <div class="elim-stats">
      <div><span class="label">Rank</span><span id="elimRank">#1</span></div>
      <div><span class="label">Elims</span><span id="elimElims">02</span></div>
    </div>
  </div>
</div>

<!-- RIGHT SIDE ALIVE TABLE + FORECAST -->
<div class="right-panel">
  <div class="table-header">
    <div class="cell">#</div>
    <div class="cell">Team</div>
    <div class="cell">Status</div>
    <div class="cell">Fin</div>
  </div>
  <div class="table-body" id="tableBody"></div>

  <div class="legend">
    <span><span class="box-alive"></span>Alive</span>
    <span><span class="box-dead"></span>Eliminated</span>
  </div>

  <div class="forecast">
    <div class="forecast-title">Forecast – Win %</div>
    <div id="forecastRows"></div>
  </div>
</div>

<script>
  /* SAME CONFIG as admin panel */
  const firebaseConfig = { databaseURL: "https://live-pt-67ab3-default-rtdb.firebaseio.com" };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  /* ------------- SETTINGS: BG PNG ------------- */
  db.ref('settings').on('value', snap=>{
    const s = snap.val() || {};
    if(s['bg-url']){
      document.getElementById('bg-image').style.backgroundImage =
        'url('+s['bg-url']+')';
    }
  });

  /* ------------- TEAMS LISTENER (MAIN OVERLAY) ------------- */
  db.ref('teams').on('value', snap=>{
    const teams = snap.val() || [];
    renderOverlay(teams);
  });

  /* ------------- LAST ELIM LISTENER (POPUP) ------------- */
  let lastTime = 0;
  db.ref('lastElim').on('value', snap=>{
    const d = snap.val();
    if(!d || !d.time || d.time === lastTime) return;
    lastTime = d.time;
    showElimPopup(d);
  });

  function showElimPopup(d){
    const p = document.getElementById('elimPopup');
    document.getElementById('elimName').innerText = d.name || 'TEAM';
    document.getElementById('elimRank').innerText = '#'+(d.rank || 0);
    document.getElementById('elimElims').innerText = ('0'+(d.kills||0)).slice(-2);
    const logoDiv = document.getElementById('elimLogo');
    logoDiv.style.backgroundImage = 'url('+(d.logo || 'https://i.ibb.co/VWVx67n/default.png')+')';
    p.style.display = 'grid';
    setTimeout(()=>{p.style.display='none';},3000);
  }

  /* ------------- RENDER UI: TOP BAR + TABLE + FORECAST ------------- */
  function renderOverlay(teams){
    const tableBody = document.getElementById('tableBody');
    const forecastRows = document.getElementById('forecastRows');
    const topBar = document.getElementById('topBar');

    tableBody.innerHTML = '';
    forecastRows.innerHTML = '';
    topBar.innerHTML = '';

    // sort for table: alive first, then by (basePts + kills*2)
    const sorted = [...teams].sort((a,b)=>{
      if(a.dead !== b.dead) return a.dead ? 1 : -1;
      const sa = (a.basePts||0) + (a.kills||0)*2;
      const sb = (b.basePts||0) + (b.kills||0)*2;
      return sb - sa;
    });

    // table rows
    sorted.forEach((t,idx)=>{
      const aliveBars = new Array(4).fill(0).map((_,i)=>`
        <div class="status-bar" style="opacity:${i < (t.alive||0) ? 1 : 0.15}"></div>
      `).join('');
      const row = document.createElement('div');
      row.className = 'table-row'+(t.dead ? ' row-dead' : '');
      row.innerHTML = `
        <div class="cell">${idx+1}</div>
        <div class="cell">${(t.tag || t.name || 'TEAM').substring(0,4)}</div>
        <div class="cell"><div class="status-bars">${aliveBars}</div></div>
        <div class="cell">${t.finish || ''}</div>
      `;
      tableBody.appendChild(row);
    });

    // top bar: top 4 alive teams
    const aliveSorted = sorted.filter(t=>!t.dead).slice(0,4);
    aliveSorted.forEach((t,idx)=>{
      const wrap = document.createElement('div');
      wrap.className = 'team-strip-wrap';
      const lives = new Array(4).fill(0).map((_,i)=>`
        <div class="life-bar" style="opacity:${i < (t.alive||0) ? 1 : 0.15}"></div>
      `).join('');
      wrap.innerHTML = `
        <div class="team-strip">
          <div class="team-strip-logo"
               style="background-image:url(${t.logo || ''});">
            ${(!t.logo && t.name)? (t.name[0] || 'T') : ''}
          </div>
          <div class="team-strip-body">
            <div class="team-strip-header">
              <span>${t.name || 'TEAM'}</span>
              <span class="small">#${idx+1}</span>
            </div>
            <div class="team-strip-footer">
              <div class="life-bars">${lives}</div>
              <div class="kills-box">${t.kills || 0}</div>
            </div>
          </div>
        </div>
      `;
      topBar.appendChild(wrap);
    });

    // forecast: last 5 alive (or top 5 alive)
    const topForecast = aliveSorted.slice(0,5);
    let totalScore = 0;
    const scores = topForecast.map(t=>{
      const sc = (t.basePts||0) + (t.kills||0)*2 + 10;
      totalScore += sc;
      return {t,sc};
    });
    scores.forEach(s=>{
      const pct = totalScore ? Math.round((s.sc/totalScore)*100) : 0;
      const row = document.createElement('div');
      row.className = 'forecast-row';
      row.innerHTML = `<span>${(s.t.tag || s.t.name || 'TEAM').substring(0,4)}</span><span>${pct}%</span>`;
      forecastRows.appendChild(row);
    });
  }
</script>
</body>
</html>
